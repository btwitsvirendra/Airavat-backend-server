// =============================================================================
// AIRAVAT B2B MARKETPLACE - PRISMA SCHEMA V3 ADDITIONS
// All New Models for V3 Features
// =============================================================================

// ===========================================================================
// WALLET & CREDIT SYSTEM
// ===========================================================================

model Wallet {
  id          String   @id @default(cuid())
  businessId  String   @unique
  balance     Decimal  @default(0) @db.Decimal(15, 2)
  holdBalance Decimal  @default(0) @db.Decimal(15, 2)
  currency    String   @default("INR")
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  transactions WalletTransaction[]
  business     Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
}

model WalletTransaction {
  id            String   @id @default(cuid())
  walletId      String
  transactionId String   @unique
  type          String   // CREDIT, DEBIT
  amount        Decimal  @db.Decimal(15, 2)
  description   String?
  category      String   // DEPOSIT, WITHDRAWAL, PAYMENT, REFUND, TRANSFER
  status        String   @default("PENDING")
  referenceType String?
  referenceId   String?
  metadata      Json?
  createdAt     DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id])

  @@index([walletId])
  @@index([transactionId])
}

model CreditLine {
  id              String    @id @default(cuid())
  businessId      String    @unique
  requestedAmount Decimal   @db.Decimal(15, 2)
  approvedAmount  Decimal?  @db.Decimal(15, 2)
  availableCredit Decimal   @default(0) @db.Decimal(15, 2)
  usedCredit      Decimal   @default(0) @db.Decimal(15, 2)
  creditLimit     Decimal?  @db.Decimal(15, 2)
  creditScore     Int?
  interestRate    Decimal?  @db.Decimal(5, 2)
  status          String    @default("PENDING")
  billingCycleDay Int?      @default(1)
  gracePeriodDays Int?      @default(15)
  activatedAt     DateTime?
  expiresAt       DateTime?
  applicationData Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  transactions CreditTransaction[]
  business     Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
}

model CreditTransaction {
  id            String   @id @default(cuid())
  creditLineId  String
  transactionId String   @unique
  type          String   // USAGE, PAYMENT, INTEREST, FEE
  amount        Decimal  @db.Decimal(15, 2)
  description   String?
  referenceType String?
  referenceId   String?
  balanceAfter  Decimal  @db.Decimal(15, 2)
  metadata      Json?
  createdAt     DateTime @default(now())

  creditLine CreditLine @relation(fields: [creditLineId], references: [id])

  @@index([creditLineId])
}

// ===========================================================================
// GST COMPLIANCE
// ===========================================================================

model EInvoice {
  id            String    @id @default(cuid())
  orderId       String    @unique
  invoiceNumber String
  invoiceDate   DateTime
  irn           String?   @unique
  ackNumber     String?
  ackDate       DateTime?
  signedInvoice String?   @db.Text
  signedQRCode  String?   @db.Text
  qrCodeImage   String?   @db.Text
  status        String    @default("PENDING")
  invoiceData   Json?
  sellerGstin   String?
  buyerGstin    String?
  totalValue    Decimal   @db.Decimal(15, 2)
  taxableValue  Decimal   @db.Decimal(15, 2)
  cgstAmount    Decimal   @default(0) @db.Decimal(15, 2)
  sgstAmount    Decimal   @default(0) @db.Decimal(15, 2)
  igstAmount    Decimal   @default(0) @db.Decimal(15, 2)
  cessAmount    Decimal   @default(0) @db.Decimal(15, 2)
  cancelledAt   DateTime?
  cancelReason  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([irn])
}

model EWayBill {
  id              String    @id @default(cuid())
  orderId         String
  ewbNumber       String    @unique
  ewbDate         DateTime
  validUpto       DateTime
  generatedBy     String
  supplyType      String
  subSupplyType   String
  docType         String
  docNumber       String
  docDate         DateTime
  fromGstin       String
  fromPlace       String?
  fromPincode     String?
  fromState       String?
  toGstin         String?
  toPlace         String?
  toPincode       String?
  toState         String?
  transMode       String?
  transDocNumber  String?
  transDocDate    DateTime?
  vehicleNumber   String?
  vehicleType     String?
  transporterId   String?
  transporterName String?
  totalValue      Decimal   @db.Decimal(15, 2)
  cgstValue       Decimal   @default(0) @db.Decimal(15, 2)
  sgstValue       Decimal   @default(0) @db.Decimal(15, 2)
  igstValue       Decimal   @default(0) @db.Decimal(15, 2)
  cessValue       Decimal   @default(0) @db.Decimal(15, 2)
  distance        Int?
  status          String    @default("GENERATED")
  cancelledAt     DateTime?
  cancelReason    String?
  ewbData         Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([ewbNumber])
}

// ===========================================================================
// BULK UPLOAD
// ===========================================================================

model BulkUploadJob {
  id            String    @id @default(cuid())
  businessId    String
  userId        String
  jobType       String    // products, inventory, prices
  fileName      String
  fileUrl       String?
  fileSize      Int
  status        String    @default("PENDING")
  totalRows     Int?
  processedRows Int?      @default(0)
  successRows   Int?      @default(0)
  errorRows     Int?      @default(0)
  errors        Json?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())

  @@index([businessId])
  @@index([status])
}

// ===========================================================================
// FLASH DEALS & COUPONS
// ===========================================================================

model FlashDeal {
  id               String    @id @default(cuid())
  businessId       String
  productId        String
  title            String
  description      String?
  originalPrice    Decimal   @db.Decimal(15, 2)
  dealPrice        Decimal   @db.Decimal(15, 2)
  discountPercent  Decimal   @db.Decimal(5, 2)
  startTime        DateTime
  endTime          DateTime
  maxQuantity      Int?
  soldQuantity     Int       @default(0)
  maxPerCustomer   Int       @default(1)
  minOrderQuantity Int       @default(1)
  status           String    @default("SCHEDULED")
  featured         Boolean   @default(false)
  bannerImage      String?
  termsConditions  String?
  cancelledAt      DateTime?
  cancelReason     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id])
  product  Product  @relation(fields: [productId], references: [id])

  @@index([businessId])
  @@index([status])
  @@index([startTime, endTime])
}

model Coupon {
  id                     String    @id @default(cuid())
  businessId             String?
  code                   String    @unique
  name                   String
  description            String?
  discountType           String    // PERCENTAGE, FIXED, FREE_SHIPPING
  discountValue          Decimal   @db.Decimal(15, 2)
  maxDiscountAmount      Decimal?  @db.Decimal(15, 2)
  minOrderAmount         Decimal   @default(0) @db.Decimal(15, 2)
  minQuantity            Int?
  validFrom              DateTime
  validUntil             DateTime?
  usageLimit             Int?
  usagePerUser           Int       @default(1)
  usageCount             Int       @default(0)
  isActive               Boolean   @default(true)
  applicableProducts     String[]  @default([])
  applicableCategories   String[]  @default([])
  excludedProducts       String[]  @default([])
  excludedCategories     String[]  @default([])
  applicableUsers        String[]  @default([])
  applicableBusinessTypes String[] @default([])
  isFirstOrderOnly       Boolean   @default(false)
  stackable              Boolean   @default(false)
  autoApply              Boolean   @default(false)
  metadata               Json?
  deletedAt              DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  usages CouponUsage[]

  @@index([code])
  @@index([isActive])
}

model CouponUsage {
  id             String   @id @default(cuid())
  couponId       String
  userId         String
  orderId        String?
  discountAmount Decimal  @db.Decimal(15, 2)
  createdAt      DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id])

  @@index([couponId])
  @@index([userId])
}

// ===========================================================================
// WAREHOUSE & INVENTORY
// ===========================================================================

model Warehouse {
  id             String   @id @default(cuid())
  businessId     String
  name           String
  code           String   @unique
  type           String   @default("STORAGE")
  addressLine1   String
  addressLine2   String?
  city           String
  state          String
  pincode        String
  country        String   @default("India")
  coordinates    Json?
  contactName    String?
  contactPhone   String?
  contactEmail   String?
  capacity       Int?
  capacityUnit   String?
  operatingHours Json?
  facilities     String[] @default([])
  isActive       Boolean  @default(true)
  isPrimary      Boolean  @default(false)
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  inventory         WarehouseInventory[]
  transfersFrom     InventoryTransfer[]  @relation("TransferFrom")
  transfersTo       InventoryTransfer[]  @relation("TransferTo")

  @@index([businessId])
  @@index([code])
}

model WarehouseInventory {
  id               String   @id @default(cuid())
  warehouseId      String
  variantId        String
  quantity         Int      @default(0)
  reservedQuantity Int      @default(0)
  reorderPoint     Int?
  reorderQuantity  Int?
  binLocation      String?
  updatedAt        DateTime @updatedAt

  warehouse Warehouse      @relation(fields: [warehouseId], references: [id])
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([warehouseId, variantId])
  @@index([warehouseId])
  @@index([variantId])
}

model InventoryTransfer {
  id              String    @id @default(cuid())
  fromWarehouseId String
  toWarehouseId   String
  variantId       String
  quantity        Int
  reason          String?
  status          String    @default("PENDING")
  completedAt     DateTime?
  createdAt       DateTime  @default(now())

  fromWarehouse Warehouse @relation("TransferFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse @relation("TransferTo", fields: [toWarehouseId], references: [id])

  @@index([fromWarehouseId])
  @@index([toWarehouseId])
}

// ===========================================================================
// 2FA & SECURITY
// ===========================================================================

model OtpCode {
  id        String    @id @default(cuid())
  userId    String
  type      String    // sms, email
  code      String
  expiresAt DateTime
  attempts  Int       @default(0)
  verified  Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@unique([userId, type])
  @@index([userId])
}

model TwoFactorSetup {
  id          String    @id @default(cuid())
  userId      String    @unique
  secret      String
  enabled     Boolean   @default(false)
  enabledAt   DateTime?
  disabledAt  DateTime?
  backupCodes String[]  @default([])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

model UserDevice {
  id         String    @id @default(cuid())
  userId     String
  token      String    @unique
  fingerprint String?
  deviceType String
  deviceName String?
  osVersion  String?
  appVersion String?
  lastActive DateTime  @default(now())
  createdAt  DateTime  @default(now())

  @@index([userId])
  @@index([token])
}

// ===========================================================================
// FRAUD DETECTION
// ===========================================================================

model RiskAssessment {
  id         String   @id @default(cuid())
  userId     String?
  businessId String?
  orderId    String?
  riskScore  Int
  riskLevel  String
  signals    Json?
  action     String?
  assessedAt DateTime @default(now())

  @@index([userId])
  @@index([businessId])
  @@index([orderId])
}

model FraudAlert {
  id            String    @id @default(cuid())
  userId        String?
  businessId    String?
  alertType     String
  severity      String
  message       String
  transactionId String?
  status        String    @default("PENDING")
  reviewNotes   String?
  reviewedBy    String?
  reviewedAt    DateTime?
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([businessId])
  @@index([status])
}

model IpBlacklist {
  id        String   @id @default(cuid())
  ipAddress String   @unique
  reason    String?
  addedBy   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([ipAddress])
}

// ===========================================================================
// DOCUMENT VAULT
// ===========================================================================

model Document {
  id                String    @id @default(cuid())
  businessId        String
  uploadedBy        String
  documentId        String    @unique
  documentType      String
  fileName          String
  fileSize          Int
  mimeType          String
  fileHash          String
  encryptedPath     String
  status            String    @default("PENDING_VERIFICATION")
  expiresAt         DateTime?
  verifiedBy        String?
  verifiedAt        DateTime?
  verificationNotes String?
  deletedAt         DateTime?
  deletedBy         String?
  deleteReason      String?
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  accessGrants DocumentAccessGrant[]
  accessTokens DocumentAccessToken[]
  auditLogs    DocumentAuditLog[]

  @@index([businessId])
  @@index([documentId])
  @@index([documentType])
}

model DocumentAccessGrant {
  id         String    @id @default(cuid())
  documentId String
  grantedBy  String
  grantedTo  String
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())

  document Document @relation(fields: [documentId], references: [id])

  @@index([documentId])
  @@index([grantedTo])
}

model DocumentAccessToken {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])

  @@index([token])
}

model DocumentAuditLog {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  action     String
  reason     String?
  metadata   Json?
  timestamp  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@index([documentId])
  @@index([userId])
}

// ===========================================================================
// AUDIT LOG
// ===========================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  businessId String?
  action     String
  entityType String
  entityId   String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  timestamp  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([businessId])
  @@index([entityType])
  @@index([timestamp])
}

// ===========================================================================
// NOTIFICATIONS
// ===========================================================================

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  actionUrl String?
  category  String    @default("GENERAL")
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

